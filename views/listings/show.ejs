<% layout("/layouts/boilerplate") %>

<link rel="stylesheet" href="/css/showListing.css">

<script>
    const mapToken = "<%= process.env.MAP_TOKEN %>";
    const listing = JSON.parse('<%- JSON.stringify(listing) %>');
</script>

<div class="listing-container">
  <!-- LEFT: Listing Content -->
  <div class="listing-details">
    <!-- Title, Image, Description -->
    <h2><%= listing.title %></h2>

    <div class="card show-card listing-card">
      <img src="<%= listing.image.url %>" class="card-img-top show-img" alt="listing_image" />
      <div class="card-body">
        <p class="card-text"><%= listing.description %></p>
        <p class="card-text">&#8377;<%= listing.price.toLocaleString("en-IN") %> / night</p>
        <p class="card-text"><%= listing.location %>, <%= listing.country %></p>
        <form action="/create-payment" method="POST">
          <input type="hidden" name="amount" value="<%= listing.price %>"> 
          <button type="submit" class="btn btn-airbnb w-100">Book This Stay</button>
        </form>
      </div>
    </div>

    <!-- Host -->
    <div class="mt-4 p-4 border rounded bg-light">
        <h3>Meet your host</h3>
        <div class="d-flex align-items-center mb-3">
          <i class="fa-solid fa-user-circle fa-2x me-3"></i>
          <h5 class="mb-0"><%= listing.owner.username %></h5>
        </div>
        <p><strong>Email:</strong> <%= listing.owner.email %></p>
      
        <% 
          const reviews = Math.floor(Math.random() * 10) + 1;
          const rating = (Math.random() * 1 + 4).toFixed(2);
          const yearsHosting = Math.floor(Math.random() * 5) + 1;
      
          const messages = [
            `Hi, I'm ${listing.owner.username} and I love hosting travelers from all around the world.`,
            `Welcome! This is ${listing.owner.username}'s cozy space — feel free to reach out anytime.`,
            `Hello! I'm ${listing.owner.username}, happy to host you here.`,
            `Hey there! This is ${listing.owner.username}'s place, enjoy your stay.`,
            `${listing.owner.username} here! Looking forward to making your trip great.`
          ];
      
          const randomIndex = Math.floor(Math.random() * messages.length);
        %>
      
        <p><strong>Superhost</strong> · <%= reviews %> reviews · <%= rating %> rating · <%= yearsHosting %> years hosting</p>
        <p><%= messages[randomIndex] %></p>
      
        <a href="mailto:<%= listing.owner.email %>" class="btn btn-outline-dark">Message Host</a>
      </div>
      
      
      
      

    <!-- edit & delete -->
     <!-- Edit/Delete Buttons (add here) -->
<% if (currUser && listing.owner && currUser._id.toString() === listing.owner._id.toString()) { %>
    <div class="mt-3">
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning">Edit</a>
      <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
        <button class="btn btn-danger">Delete</button>
      </form>
    </div>
  <% } %>

    <!-- Map -->
    <div class="mt-4">
      <h3>Where you'll be</h3>
      <div id="map"></div>
    </div>

    <br>
    <!-- What this place offers -->
<div class="col-8 offset-2 mb-4 p-4 border rounded" style="background-color: #f8f8f8; margin-left: 0;">
    <h3>What this place offers</h3>
    <div class="row">
      <div class="col-md-6">
        <p><i class="fa-solid fa-utensils me-2"></i> Kitchen</p>
        <p><i class="fa-solid fa-car me-2"></i> Free parking on premises</p>
        <p><i class="fa-solid fa-dog me-2"></i> Pets allowed</p>
        <p><i class="fa-solid fa-door-open me-2"></i> Private patio or balcony</p>
      </div>
      <div class="col-md-6">
        <p><i class="fa-solid fa-fire me-2"></i> Indoor fireplace: wood-burning</p>
        <p><i class="fa-solid fa-fire-burner me-2"></i> Firepit</p>
        <p><i class="fa-solid fa-snowflake me-2"></i> Fridge</p>
      </div>
    </div>
  </div>
  
    

    <!-- Reviews -->
    <% if(currUser) { %>
    <hr />
    <h4>Leave a review</h4>
    <form action="/listings/<%= listing.id %>/reviews" method="POST" novalidate class="needs-validation">
      <!-- Rating -->
      <div class="mb-3">
        <label class="form-label">Rating</label>
        <fieldset class="starability-slot">
          <!-- Stars here -->
        </fieldset>
      </div>
      <!-- Comment -->
      <div class="mb-3">
        <label class="form-label">Comments</label>
        <textarea name="review[comment]" class="form-control" required></textarea>
        <div class="invalid-feedback">Please add some comments</div>
      </div>
      <button class="btn btn-outline-dark">Submit</button>
    </form>
    <hr />
    <% } %>

    <% if(listing.reviews.length > 0) { %>
      <h4>All Reviews</h4>
      <% for(let review of listing.reviews) { %>
        <div class="card mb-3">
          <div class="card-body">
            <h5>@<%= review.author.username %></h5>
            <p data-rating="<%= review.rating %>"></p>
            <p><%= review.comment %></p>
            <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
              <button class="btn btn-sm btn-dark">Delete</button>
            </form>
          </div>
        </div>
      <% } %>
    <% } %>
  </div>

    <!-- Right Side: Booking Section -->
    <div class="booking-box">
        <%
        const originalPrice = listing.price;
        const discountedPrice = Math.round(originalPrice * 0.8);
        const numberOfNights = 5;
        const totalBeforeDiscount = originalPrice * numberOfNights;
        const discountAmount = originalPrice - discountedPrice;
        const totalDiscount = discountAmount * numberOfNights;
        const serviceFee = Math.round(originalPrice * 0.1); // fixed fee = 1 night at discounted rate
        const finalTotal = totalBeforeDiscount - totalDiscount + serviceFee;
        %>
    
        <div class="price-info">
        <span class="original-price">&#8377;<%= originalPrice.toLocaleString("en-IN") %></span>
        <span class="discounted-price">&#8377;<%= discountedPrice.toLocaleString("en-IN") %></span> <span class="per-night">night</span>
        </div>
    
        <form action="/bookings/create" method="POST">
            <input type="hidden" name="listingId" value="<%= listing._id %>">
        
            <% const today = new Date().toISOString().split("T")[0]; %>
        
            <div class="date-picker">
                <label>Check-in</label>
                <input type="date" name="checkin" min="<%= today %>" required>
        
                <label>Checkout</label>
                <input type="date" name="checkout" min="<%= today %>" required>
            </div>
        
            <div class="guest-picker">
                <label>Guests</label>
                <select name="guests" required>
                    <option value="1">1 guest</option>
                    <option value="2">2 guests</option>
                    <option value="3">3 guests</option>
                    <option value="4">4 guests</option>
                </select>
            </div>
        
            <div class="payment-method">
                <label>Payment Method</label>
                <select name="paymentMethod" required>
                    <option value="cash">Cash</option>
                    <option value="upi">UPI</option>
                </select>
            </div>
        
            <button type="submit" class="reserve-btn">Reserve</button>
            <p class="disclaimer">You won't be charged yet</p>
        </form>
        
        
    
        <div class="price-breakdown">
        <div>
            &#8377;<%= originalPrice.toLocaleString("en-IN") %> x <%= numberOfNights %> nights
            <span>&#8377;<%= totalBeforeDiscount.toLocaleString("en-IN") %></span>
        </div>
        <div>
            Long stay discount
            <span>-&#8377;<%= totalDiscount.toLocaleString("en-IN") %></span>
        </div>
        <div>
            Airbnb service fee
            <span>&#8377;<%= serviceFee.toLocaleString("en-IN") %></span>
        </div>
        <hr />
        <div class="total">
            Total <span>&#8377;<%= finalTotal.toLocaleString("en-IN") %></span>
        </div>
        </div>
    </div>
  
</div>

<script src="/js/map.js"></script>
